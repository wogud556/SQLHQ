## 9 Snapshot too old

### 정의
- 데이터를 읽어 내려가다가 쿼리 SCN 이후에 변경된 블록을 만나(이미 앞서 읽었던 블록을 다시 방문하는 경우일 수도 있음) 과거 시점으로 롤백한 "Read Consistent" 이미지를 얻으려고 하는데, Undo 블록이 다른 트랜잭션에 의해 이미 재사용돼 필요한 Undo 정보를 얻을 수 없는 경우
  - 프로그램 코딩 패턴에 문제가 없다면 Undo 세그먼트가 너무 작다는 신호
- 커밋된 트랜잭션 테이블 슬롯이 다른 트랜잭션에 의해 재사용돼 커밋 정보를 확인할 수 없는 경우로, Undo 세그먼트 개숙 적다는 신호일 수 있음

### 9-1 Undo 실패
- Undo 블록을 찾을 수 없어 에러가 발생하는 경우
- 사진하나
- 해당 쿼리는 고객별 미납금액을 계산하는 쿼리이며 1시간정도 걸림 
  1. SCN 123시점에 이 쿼리가 시작함
  2. 쿼리가 진행되는 동안 은행으로부터 고객의 입금내역을 전송받아 일괄 처리하는 배치 프로그램이 수행됨
     1. 해당프록램은 각 건별로 커밋되도록 작성
  3. 시간이 흘러 홍길동 고객의 수납액 변경내역을 담은 Undo 블록이 다른 트랜잭션에 의해 재사용됨
  4. 위 쿼리를 수행중인 프로세스가 홍길동 고객의 수납액이 담긴 블록에 도달했을 때 블록 SCN이 자신의 쿼리 SCN 123보다 큰 129임을 확인하고 변경된 undo 레코드를 찾으려고 ITL 엔트리에 기록된 UBA를 읽어 Undo 세그먼트 블록을 찾아감
  5. 하지만 Undo 블록은 이미 다른 트랜잭션에 의해 재사용된 상태이므로 ORA-01555 에러를 발생시키며 진행을 멈춤
- 다른 예로 여러 세션에서 동시에 트랜잭션이 몰리지 않더라도 아래와 같은 프로그램이 한 세션에서 독립적으로 수행되는 도중에 Snapshot too old 에러가 발생할 수 있음
- 사진하나만 추가하고 설명은 생략한다.
- 해당 사진과 같은 코딩 패턴을 fetch across commit 이라고 하는데 명시적으로 커서를 열어 로우를 하나씩 fetch 하면서 값을 변경하고 루프 내에서 계속해서 커밋을 날리는 방식임
- ANSI 표준에 따르면 열려 있던 커서는 커밋하는 시점에서 무효화되어야 하므로 사용자는 계쏙해서 fetch 해선느 안됨
- 오라클은 ansi 표준에도 불구, 사용자가 fetch across commit을 할 수 있도록 허용하고 있지만, 그렇게 할 경우 에러가 발생할 수 있는 사실을 인지한 상태에서 프로그램을 작성해야함

### 9-2 블록 클린아웃 실패
#### 트랜잭션 테이블 슬롯이 재사용돼 에러가 발생하는 경우
- 사진하나 추가
- 대량 업데이트 이후 커밋된 트랜잭션은 변경했던 블록들을 모두 클린아웃하지 않은 상태에서 자신이 사용하던 트랜잭션 테이블 슬롯을 Free 상태로 변경하고 트랜잭션을 완료함
- 이때부터 그 트랜잭션 테이블 슬롯은 다른 트랜잭션에 의해 재사용될 수 있음
- 시간이 흘러 그 변경된 블록들이 읽혀야 하는 시점에 Delayed 블록 클린아웃을 위해 트랜잭션 테니블 슬롯을 찾아갔는 데, 해당 슬롯이 다른 트랜잭션에 의해 이미 재사용되고 없다면 정상적인 블록 클린아웃과 일관성 모드 읽기가 불가능해질 수 있음

#### Undo 세금너트 헤더 블록을 갱신한 내용도 Undo 레코드로서 기록함
- 따라서 트랜잭션 테이블 슬롯이 덮어 쓰인 것을 발견하면 우선 Undo 세그먼트 헤더 블록에 가해진 변경사항을 롤백하려고 시도함
- 다행히 찾고자 하는 트랜잭션에 대한 커밋 정보가 Undo 블록에 남아있다면, 현재 읽고자 하는 블록의 정확한 커밋 SCN을 가지고 블록 클린아웃을 수행할 수 있음.
- 하지만 Undo 레코드를 뒤졌는데 그마저도 덮어쓰이고 없는 상태라면?

#### Undo 레코드가 덮어 쓰이고 없는 상태라면
- Delayed 블록 클린아웃에 의한 Snapshot too old문제를 잘못 이해하면 이 처리 프로세스에 치명적인 결함이 있다고 오해하기 쉬움
- 클린아웃에 필요한 트랜잭션 테이블과 Undo 정보는 언젠간 필연적으로 덮어 쓰이기 마련
- 갱신 후에 오랫동안 읽히지 않았던 블록이 언젠간 읽히면서 예외없이 Snapshot too old가 발생한다고 생각할 수 있을 것임
- 하지만 블록 클린아웃에 의한 Snapshot too old에러는 거의 발생하지 않음
